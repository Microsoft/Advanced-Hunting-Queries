// printnightmare-cve-2021-1675 usage detection and protection...
//     a couple useful queries by Carl Peter McCollough

// Checking for any files created in the spool drivers folder
// First thing to check for to know if this has been in use is the creation of files in the spool drivers folder.
// MANY OF THE FILES THAT SHOULD COME UP HERE MAY BE LEGIT. Unsigned files or ones that don't have any 
// relations to printers that you are using are suspicious. 
DeviceFileEvents
| where ActionType == "FileCreated"
| where FolderPath startswith "C:\\WINDOWS\\SYSTEM32\\SPOOL\\drivers"

// Finding all 445 connections - likely too much on fileservers, but useful for desktop/laptops. This can be used to detect
// if you can use firewalling to block off remote usage of the Print Spooler service. If none of the machines in the last 30
// days show up as having connections on 445 then likely it will be of no impact to turn off the default firewall rules that
// allow connections via SMB/EPMAP to the print spooler service.
DeviceNetworkEvents
| where LocalPort == 445
| summarize RemoteIPCount=dcount(RemoteIP) by DeviceName, InitiatingProcessFileName, InitiatingProcessId, InitiatingProcessCreationTime

