// Get stats on ExploitGuard events (audit, blocks, or both) - count events and machines per rule

MiscEvents
| where ActionType in ("ExploitGuardHips", "ProcessBlockGeneratingDynamicCode", "ProcessBlockCreatingChildProcess",
"LoadLowILImage", "LoadBinaryFromRemoteShare", "CallWin32k", "LoadNonMicrosoftSignedBinary", "ExportAddressFilter", 
"ImportAddressFilter", "Rop", "ExploitGuardHips", "NetworkFilterLookup")
| extend ParsedFields=parse_json(AdditionalFields)
| extend IsAudit=toboolean(ParsedFields.IsAudit), RuleId=tostring(ParsedFields.RuleId)
| where IsAudit == true
| summarize EventCount=count(), MachinesCount=dcount(ComputerName) by ActionType, RuleId

// TODO arround mid-June 2018 the first query will start returning no results, and should be replaced with this query
// Get stats on ExploitGuard blocks - count events and machines per rule
MiscEvents
| where ActionType startswith "ExploitGuard" and ActionType endswith "Blocked"
| extend RuleId=extractjson("$.RuleId", AdditionalFields, typeof(string))
// Count total stats - count events and machines per rule
| summarize EventCount=count(), MachinesCount=dcount(ComputerName) by ActionType, RuleId

// TODO arround mid-June 2018 the first query will start returning no results, and should be replaced with this query
// View ExploitGuard audit events - but remove repeating blocks (e.g. multiple events with same machine, rule, file and process)
MiscEvents
| where ActionType startswith "ExploitGuard" and ActionType endswith "Audited"
| extend RuleId=extractjson("$.RuleId", AdditionalFields, typeof(string))
| summarize EventTime =max(EventTime) by ComputerName, ActionType,RuleId,FileName, FolderPath, InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessFolderPath, InitiatingProcessId, SHA1 

