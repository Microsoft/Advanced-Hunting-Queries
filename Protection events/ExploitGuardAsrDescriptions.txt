// Expanding on MiscEvents output with Exploit Guard Attack Surface Reduction (ASR) rule descriptions
// The events in the MiscEvents table contain a GUID for the various ASR rules rather than a full description of the rule
// This query will create a table which has the description for each ASR rule as per https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-exploit-guard/enable-attack-surface-reduction
// This table is then joined to the output of a query against the MiscEvents table and shows a summary count of the events by the newly defined description
// This query shows the ability to use cross joins and custom dimension tables
// See https://docs.loganalytics.io/docs/Learn/Tutorials/Joins---cross-analysis for more information on the join syntax
// For more questions on this query, feel free to ping @FlyingBlueMonki on twitter or mattegen@microsoft.com via email
//
// First lets start by creating a table of the rule descriptions to rule guids
let AsrDescriptionTable = datatable(RuleDescription:string, RuleGuid:string)
[
"Block executable content from email client and webmail","BE9BA2D9-53EA-4CDC-84E5-9B1EEEE46550",
"Block Office applications from creating child processes","D4F940AB-401B-4EFC-AADC-AD5F3C50688A",
"Block Office applications from creating executable content","3B576869-A4EC-4529-8536-B80A7769E899",
"Block Office applications from injecting code into other processes","75668C1F-73B5-4CF0-BB93-3ECF5CB7CC84",
"Block JavaScript or VBScript from launching downloaded executable content","D3E037E1-3EB8-44C8-A917-57927947596D",
"Block execution of potentially obfuscated scripts","5BEB7EFE-FD9A-4556-801D-275E5FFC04CC",
"Block Win32 API calls from Office macro","92E97FA1-2EDF-4476-BDD6-9DD0B4DDDC7B",
"Block executable files from running unless they meet a prevalence, age, or trusted list criteria","01443614-cd74-433a-b99e-2ecdc07bfc25",
"Use advanced protection against ransomware","c1db55ab-c21a-4637-bb3f-a12568109d35",
"Block credential stealing from the Windows local security authority subsystem (lsass.exe)","9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2",
"Block process creations originating from PSExec and WMI commands","d1e49aac-8f56-4280-b9ba-993a6d77406c",
"Block untrusted and unsigned processes that run from USB","b2b3f03d-6a65-4f7b-a9c7-1c7ef74a9ba4",
"Block Office communication applications from creating child processes (available for beta testing)","26190899-1602-49e8-8b27-eb1d0a1ce869",
];
// Now we query the MiscEvents table for events in the last 30 days and where the ActionType field starts with "ExploitGuardAsr".
// (We use "startswith" rather than "==" because starts with will catch both audited (not enforced) and blocked items )
MiscEvents
| where EventTime > ago(30d)
| where ActionType startswith "ExploitGuardAsr"
//since the RuleGuid is stored inside the additionlfields column, we need to extract it for the join
// we extend the results to include a new "RuleGuid" column that is populated by the extracted RuleId from the json data in AdditionalFields
| extend RuleGuid = tostring(parsejson(AdditionalFields).RuleId)
// and finally here is where we're making our join back to the earlier defined table of rule descriptions and guids and outputting our summary count
| join kind = inner AsrDescriptionTable on RuleGuid
| summarize RuleCount = count() by RuleDescription

